<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Attendance - Antoniv University</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>
        <i class="fas fa-calendar-check"></i>
        My Attendance
      </h1>
      <p>Track your class attendance and performance</p>
    </div>
  </div>

  <div class="container">
    <!-- Attendance Summary Dashboard -->
    <div class="dashboard-grid">
      <div class="summary-card overall">
        <div class="summary-icon">
          <i class="fas fa-chart-pie"></i>
        </div>
        <div class="summary-content">
          <h3>Overall Attendance</h3>
          <div class="percentage-display" id="overallPercentage">0%</div>
          <p class="summary-text">Across all subjects</p>
        </div>
      </div>
      
      <div class="summary-card subjects">
        <div class="summary-icon">
          <i class="fas fa-book-open"></i>
        </div>
        <div class="summary-content">
          <h3>Total Subjects</h3>
          <div class="count-display" id="totalSubjects">0</div>
          <p class="summary-text">This semester</p>
        </div>
      </div>
      
      <div class="summary-card good">
        <div class="summary-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="summary-content">
          <h3>Good Attendance</h3>
          <div class="count-display" id="goodAttendance">0</div>
          <p class="summary-text">75% and above</p>
        </div>
      </div>
      
      <div class="summary-card warning">
        <div class="summary-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="summary-content">
          <h3>Low Attendance</h3>
          <div class="count-display" id="lowAttendance">0</div>
          <p class="summary-text">Below 75%</p>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-filter"></i>
          Filter Attendance
        </h2>
      </div>
      
      <div class="student-form">
        <div class="form-row">
          <div class="form-group">
            <label for="filterSemester">Filter by Semester</label>
            <select id="filterSemester">
              <option value="">All Semesters</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
            </select>
          </div>
          <div class="form-group">
            <label for="filterStatus">Filter by Status</label>
            <select id="filterStatus">
              <option value="">All Status</option>
              <option value="good">Good (â‰¥75%)</option>
              <option value="warning">Warning (65-74%)</option>
              <option value="critical">Critical (<65%)</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" id="filterBtn" class="btn btn-primary">
            <i class="fas fa-search"></i>
            Apply Filter
          </button>
          <button type="button" id="resetFilterBtn" class="btn btn-secondary">
            <i class="fas fa-undo"></i>
            Reset
          </button>
        </div>
      </div>
    </div>

    <!-- Attendance Records -->
    <div class="table-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-list"></i>
          Attendance Records
        </h2>
        <div class="student-count">Records: <span id="recordCount">0</span></div>
      </div>
      
      <div class="table-container">
        <div id="emptyState" class="empty-state" style="display: none;">
          <i class="fas fa-calendar-times"></i>
          <h3>No Attendance Records</h3>
          <p>Your attendance records will appear here once entered by faculty.</p>
        </div>
        
        <table id="attendanceTable">
          <thead>
            <tr>
              <th><i class="fas fa-book"></i> Subject</th>
              <th><i class="fas fa-code"></i> Code</th>
              <th><i class="fas fa-layer-group"></i> Semester</th>
              <th><i class="fas fa-calendar-alt"></i> Classes</th>
              <th><i class="fas fa-percentage"></i> Attendance</th>
              <th><i class="fas fa-traffic-light"></i> Status</th>
              <th><i class="fas fa-clock"></i> Last Updated</th>
            </tr>
          </thead>
          <tbody id="attendanceBody">
            <!-- Dynamic content will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Attendance Chart Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-chart-bar"></i>
          Attendance Chart
        </h2>
      </div>
      
      <div class="chart-container">
        <canvas id="attendanceChart" width="400" height="200"></canvas>
      </div>
    </div>

    <!-- Tips Section -->
    <div class="tips-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-lightbulb"></i>
          Attendance Tips
        </h2>
      </div>
      
      <div class="tips-grid">
        <div class="tip-card">
          <i class="fas fa-target"></i>
          <h3>Maintain 75% Minimum</h3>
          <p>Keep your attendance above 75% to be eligible for exams and avoid academic penalties.</p>
        </div>
        
        <div class="tip-card">
          <i class="fas fa-calendar-check"></i>
          <h3>Regular Attendance</h3>
          <p>Consistent daily attendance helps you stay updated with course content and discussions.</p>
        </div>
        
        <div class="tip-card">
          <i class="fas fa-bell"></i>
          <h3>Monitor Weekly</h3>
          <p>Check your attendance regularly to identify subjects where you need improvement.</p>
        </div>
        
        <div class="tip-card">
          <i class="fas fa-user-tie"></i>
          <h3>Communicate with Faculty</h3>
          <p>If you have genuine reasons for absence, communicate with your subject teachers.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-content">
      <p>&copy; 2025 Antoniv University. All rights reserved.</p>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE = 'https://student-crud-backend-u0nb.onrender.com/api/attendance';
    
    // Get current user (in real app, this would come from authentication)
    const currentUser = {
      studentId: 'CSE2511001', // This should be dynamically loaded from login
      name: 'John Doe',
      course: 'CSE',
      year: 2
    };
    
    // State Management
    let attendanceRecords = [];
    let filteredRecords = [];
    
    // DOM Elements
    const attendanceBody = document.getElementById('attendanceBody');
    const recordCount = document.getElementById('recordCount');
    const emptyState = document.getElementById('emptyState');
    const attendanceTable = document.getElementById('attendanceTable');
    const filterBtn = document.getElementById('filterBtn');
    const resetFilterBtn = document.getElementById('resetFilterBtn');
    
    // Summary elements
    const overallPercentageEl = document.getElementById('overallPercentage');
    const totalSubjectsEl = document.getElementById('totalSubjects');
    const goodAttendanceEl = document.getElementById('goodAttendance');
    const lowAttendanceEl = document.getElementById('lowAttendance');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      fetchAttendanceRecords();
      setupEventListeners();
    });
    
    // Event Listeners
    function setupEventListeners() {
      filterBtn.addEventListener('click', applyFilter);
      resetFilterBtn.addEventListener('click', resetFilter);
    }
    
    // Fetch attendance records for current student
    async function fetchAttendanceRecords() {
      try {
        showLoading(true);
        const response = await fetch(`${API_BASE}/student/${currentUser.studentId}`);
        
        if (response.status === 404) {
          attendanceRecords = [];
          filteredRecords = [];
          renderAttendanceRecords();
          updateSummary();
          return;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        attendanceRecords = await response.json();
        filteredRecords = [...attendanceRecords];
        renderAttendanceRecords();
        updateSummary();
        createAttendanceChart();
        
      } catch (error) {
        console.error('Error fetching attendance records:', error);
        showNotification('Failed to load attendance records. Please try again.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    // Render attendance records
    function renderAttendanceRecords(records = filteredRecords) {
      if (records.length === 0) {
        showEmptyState();
        return;
      }
      
      hideEmptyState();
      attendanceBody.innerHTML = '';
      
      records.forEach(record => {
        const row = createAttendanceRow(record);
        attendanceBody.appendChild(row);
      });
      
      updateRecordCount(records.length);
    }
    
    // Create attendance table row
    function createAttendanceRow(record) {
      const row = document.createElement('tr');
      const percentage = Math.round(record.attendancePercentage);
      const status = getAttendanceStatus(percentage);
      
      row.innerHTML = `
        <td>
          <strong>${record.subject}</strong>
        </td>
        <td>${record.subjectCode}</td>
        <td>
          <span class="semester-badge">Sem ${record.semester}</span>
        </td>
        <td>
          <div class="classes-info">
            <strong>${record.attendedClasses}/${record.totalClasses}</strong>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentage}%"></div>
            </div>
          </div>
        </td>
        <td>
          <span class="percentage-badge ${getPercentageClass(percentage)}">
            ${percentage}%
          </span>
        </td>
        <td>
          <span class="status-badge ${status.class}">
            <i class="${status.icon}"></i>
            ${status.text}
          </span>
        </td>
        <td>
          <small>${formatDate(record.lastUpdated)}</small>
        </td>
      `;
      return row;
    }
    
    // Update summary dashboard
    function updateSummary() {
      const totalSubjects = attendanceRecords.length;
      
      if (totalSubjects === 0) {
        overallPercentageEl.textContent = '0%';
        totalSubjectsEl.textContent = '0';
        goodAttendanceEl.textContent = '0';
        lowAttendanceEl.textContent = '0';
        return;
      }
      
      const overallPercentage = attendanceRecords.reduce((sum, record) => 
        sum + record.attendancePercentage, 0) / totalSubjects;
      
      const goodCount = attendanceRecords.filter(record => 
        record.attendancePercentage >= 75).length;
      
      const lowCount = attendanceRecords.filter(record => 
        record.attendancePercentage < 75).length;
      
      overallPercentageEl.textContent = `${Math.round(overallPercentage)}%`;
      totalSubjectsEl.textContent = totalSubjects;
      goodAttendanceEl.textContent = goodCount;
      lowAttendanceEl.textContent = lowCount;
      
      // Update overall percentage color
      updatePercentageColor(overallPercentageEl, overallPercentage);
    }
    
    // Create attendance chart
    function createAttendanceChart() {
      const canvas = document.getElementById('attendanceChart');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (attendanceRecords.length === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const barWidth = canvas.width / attendanceRecords.length - 20;
      const maxHeight = canvas.height - 60;
      
      attendanceRecords.forEach((record, index) => {
        const percentage = record.attendancePercentage;
        const barHeight = (percentage / 100) * maxHeight;
        const x = index * (barWidth + 20) + 10;
        const y = canvas.height - barHeight - 30;
        
        // Draw bar
        ctx.fillStyle = getChartColor(percentage);
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Draw percentage text
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${Math.round(percentage)}%`, x + barWidth / 2, y - 5);
        
        // Draw subject code
        ctx.save();
        ctx.translate(x + barWidth / 2, canvas.height - 5);
        ctx.rotate(-Math.PI / 4);
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(record.subjectCode, 0, 0);
        ctx.restore();
      });
    }
    
    // Apply filter
    function applyFilter() {
      const semester = document.getElementById('filterSemester').value;
      const status = document.getElementById('filterStatus').value;
      
      filteredRecords = attendanceRecords.filter(record => {
        let match = true;
        
        if (semester && record.semester != semester) {
          match = false;
        }
        
        if (status) {
          const percentage = record.attendancePercentage;
          if (status === 'good' && percentage < 75) match = false;
          if (status === 'warning' && (percentage < 65 || percentage >= 75)) match = false;
          if (status === 'critical' && percentage >= 65) match = false;
        }
        
        return match;
      });
      
      renderAttendanceRecords();
    }
    
    // Reset filter
    function resetFilter() {
      document.getElementById('filterSemester').value = '';
      document.getElementById('filterStatus').value = '';
      filteredRecords = [...attendanceRecords];
      renderAttendanceRecords();
    }
    
    // Helper functions
    function getAttendanceStatus(percentage) {
      if (percentage >= 75) {
        return { text: 'Good', class: 'status-good', icon: 'fas fa-check-circle' };
      } else if (percentage >= 65) {
        return { text: 'Warning', class: 'status-warning', icon: 'fas fa-exclamation-triangle' };
      } else {
        return { text: 'Critical', class: 'status-critical', icon: 'fas fa-times-circle' };
      }
    }
    
    function getPercentageClass(percentage) {
      if (percentage >= 75) return 'percentage-good';
      if (percentage >= 65) return 'percentage-warning';
      return 'percentage-critical';
    }
    
    function getChartColor(percentage) {
      if (percentage >= 75) return '#28a745';
      if (percentage >= 65) return '#ffc107';
      return '#dc3545';
    }
    
    function updatePercentageColor(element, percentage) {
      if (percentage >= 75) {
        element.style.color = '#28a745';
      } else if (percentage >= 65) {
        element.style.color = '#ffc107';
      } else {
        element.style.color = '#dc3545';
      }
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }
    
    function updateRecordCount(count) {
      recordCount.textContent = count;
    }
    
    function showEmptyState() {
      emptyState.style.display = 'block';
      attendanceTable.style.display = 'none';
    }
    
    function hideEmptyState() {
      emptyState.style.display = 'none';
      attendanceTable.style.display = 'table';
    }
    
    function showLoading(isLoading) {
      if (isLoading) {
        attendanceBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="loading"></div>
              <span style="margin-left: 10px;">Loading your attendance records...</span>
            </td>
          </tr>
        `;
      }
    }
    
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
  
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
    }
    
    .summary-icon {
      font-size: 3rem;
      padding: 15px;
      border-radius: 12px;
    }
    
    .overall .summary-icon { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .subjects .summary-icon { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }
    .good .summary-icon { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
    .warning .summary-icon { background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; }
    
    .summary-content h3 {
      font-size: 1rem;
      color: #666;
      margin-bottom: 8px;
    }
    
    .percentage-display {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
    }
    
    .count-display {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
    }
    
    .summary-text {
      font-size: 0.9rem;
      color: #888;
      margin-top: 5px;
    }
    
    .semester-badge {
      background: #e9ecef;
      color: #495057;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .classes-info {
      text-align: center;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      transition: width 0.3s ease;
    }
    
    .percentage-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .percentage-good { background: #d4edda; color: #155724; }
    .percentage-warning { background: #fff3cd; color: #856404; }
    .percentage-critical { background: #f8d7da; color: #721c24; }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: 500;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-good { background: #d4edda; color: #155724; }
    .status-warning { background: #fff3cd; color: #856404; }
    .status-critical { background: #f8d7da; color: #721c24; }
    
    .chart-container {
      padding: 30px;
      background: white;
      border-radius: 8px;
      text-align: center;
    }
    
    .tips-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .tips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 30px;
    }
    
    .tip-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #667eea;
    }
    
    .tip-card i {
      font-size: 2rem;
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .tip-card h3 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 10px;
    }
    
    .tip-card p {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e8ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .summary-card {
        padding: 20px;
        gap: 15px;
      }
      
      .summary-icon {
        font-size: 2.5rem;
        padding: 12px;
      }
      
      .percentage-display {
        font-size: 2rem;
      }
      
      .count-display {
        font-size: 1.5rem;
      }
      
      .tips-grid {
        grid-template-columns: 1fr;
        padding: 20px;
      }
    }
  </style>
</body>
</html>